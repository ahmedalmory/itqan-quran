<?php
// إنشاء مجلد التنزيلات إذا لم يكن موجوداً
if (!file_exists(__DIR__ . '/templates')) {
    mkdir(__DIR__ . '/templates', 0777, true);
}

// بدء جلسة الجلسة
session_start();

// التحقق من تسجيل الدخول
require_once '../config/auth.php';
requireRole(['super_admin', 'department_admin']);

// تعريف العناوين
$headers = [
    'الاسم',
    'البريد الالكتروني',
    'رقم الهاتف',
    'تاريخ الميلاد',
    'الجنس',
    'الجنسية',
    'اسم الحلقة',
    'وقت الحلقة',
    'المعلم'
];

// بيانات أمثلة متعددة
$examples = [
    // مثال 1: طالب ذكر مع وقت حلقة بعد الصلاة
    [
        'محمد أحمد',
        'mohammed.ahmed@example.com',
        '0501234567',
        '2010-01-01',
        'ذكر',
        'سعودي',
        'حلقة الفرقان',
        'بعد العصر',
        'عبدالله محمد'
    ],
    // مثال 2: طالبة أنثى مع وقت حلقة محدد
    [
        'نورة محمد',
        'noura.mohammed@example.com',
        '0507654321',
        '2011-05-15',
        'أنثى',
        'سعودي',
        'حلقة النور',
        '16:00-18:00',
        'فاطمة علي'
    ],
    // مثال 3: طالب ذكر مع وقت حلقة آخر
    [
        'خالد عبدالله',
        'khalid.abdullah@example.com',
        '0509876543',
        '2009-10-20',
        'ذكر',
        'مصري',
        'حلقة الإخلاص',
        'بعد المغرب',
        'محمد سعيد'
    ]
];

// إنشاء ملف CSV جديد
$filename = __DIR__ . '/templates/students_import_template.csv';

// فتح الملف للكتابة مع ترميز UTF-8
$file = fopen($filename, 'w');

// إضافة BOM للتعرف على UTF-8
fwrite($file, "\xEF\xBB\xBF");

// كتابة العناوين
fputcsv($file, $headers);

// كتابة بيانات الأمثلة
foreach ($examples as $example) {
    fputcsv($file, $example);
}

// إغلاق الملف
fclose($file);

// إنشاء ملف README للتعليمات
$readme = <<<EOT
تعليمات استيراد الطلاب:

1. افتح الملف باستخدام Excel أو أي برنامج مماثل
2. أدخل بيانات الطلاب في الأعمدة المناسبة
3. احفظ الملف بتنسيق CSV مع ترميز UTF-8
4. تأكد من عدم تغيير أسماء الأعمدة

ملاحظات هامة:
- جميع الحقول إلزامية
- الجنس يجب أن يكون "ذكر" أو "أنثى"
- تاريخ الميلاد يجب أن يكون بتنسيق YYYY-MM-DD (مثل 2010-01-15)
- وقت الحلقة يمكن أن يكون:
  * بتنسيق ساعات (مثل 16:00-18:00)
  * أو بعد إحدى الصلوات: بعد الفجر، بعد الظهر، بعد العصر، بعد المغرب، بعد العشاء
- اسم المعلم يجب أن يكون مطابقاً لاسم مستخدم موجود في النظام بصلاحية معلم
- الجنسية يجب أن تكون موجودة في قائمة الجنسيات المعتمدة في النظام

أسماء الأعمدة المطلوبة:
- الاسم: الاسم الكامل للطالب
- البريد الالكتروني: بريد إلكتروني صالح وفريد لكل طالب
- رقم الهاتف: رقم هاتف الطالب أو ولي الأمر
- تاريخ الميلاد: تاريخ ميلاد الطالب بتنسيق YYYY-MM-DD
- الجنس: ذكر أو أنثى
- الجنسية: جنسية الطالب (يجب أن تكون موجودة في النظام)
- اسم الحلقة: اسم الحلقة التي سينضم إليها الطالب
- وقت الحلقة: وقت الحلقة (ساعات محددة أو بعد إحدى الصلوات)
- المعلم: اسم معلم الحلقة (يجب أن يكون مستخدم موجود في النظام)

ملاحظة: سيتم إنشاء كلمة مرور عشوائية لكل طالب جديد. يمكن للمشرف تغييرها لاحقاً.
EOT;

file_put_contents(__DIR__ . '/templates/README.txt', $readme);

// تنزيل ملف CSV
header('Content-Type: text/csv; charset=UTF-8');
header('Content-Disposition: attachment; filename="students_import_template.csv"');
header('Content-Length: ' . filesize($filename));
readfile($filename);
exit;
?>
